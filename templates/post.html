<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Create Post</title>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600&amp;display=swap"
    rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="/static/styles.css">
  <link rel="stylesheet" href="/static/css/post.css">

</head>

<body>
  <header class="header" role="banner">
    <a href="/" class="logo">
      <i class="fas fa-rocket"></i>
      The Forum
    </a>

    <div class="search" role="search">
      <i class="fas fa-search" aria-hidden="true"></i>
      <input type="text" placeholder="Search MyReddit" aria-label="Search posts" />
    </div>

    <div class="nav-right">
      <a href="/" class="nav-link">Home</a> <!-- redirect to homepage after successful creation for post. -->
      <!-- <button class="create-post-btn" aria-label="Create new post">
			<a href="/create-post-form">Create-Post</a>
		  </button> -->
      <div id="notification" class="hidden"></div> <!-- for notification pop-up -->
      <button class="nav-btn" aria-label="Notifications">
        <i class="far fa-bell" aria-hidden="true"></i>
      </button>
      <button class="nav-btn" aria-label="Messages">
        <i class="far fa-comment-alt" aria-hidden="true"></i>
      </button>
      <div class="user-dropdown">
        <button class="nav-btn" aria-label="User menu">
          <img src="/static/user.png" alt="User avatar" class="user-avatar" />
        </button>
        <div class="user-menu" role="menu">
          {{if .IsLoggedIn}}
          <span class="welcome-message" role="menuitem">Hi {{.UserName}}</span>
          <a href="/logout" class="user-menu-item" role="menuitem">
            <i class="fas fa-sign-out-alt" aria-hidden="true"></i> Logout
          </a>
          {{else}}
          <a href="/login" class="user-menu-item" role="menuitem">
            <i class="fas fa-sign-in-alt" aria-hidden="true"></i> Log In
          </a>
          <a href="/signup" class="user-menu-item" role="menuitem">
            <i class="fas fa-user-plus" aria-hidden="true"></i> Sign Up
          </a>
          {{end}}
        </div>
      </div>
    </div>
  </header>
  <div class="container">
    <div class="post-container">
      <h2>Create a New Post</h2>
      <form action="/create-post" method="POST">
        <div class="form-group">
          <label for="title">Title:</label>
          <input type="text" id="title" name="title" required placeholder="Enter the post title">
        </div>

        <div class="form-group">
          <label for="content">Content:</label>
          <textarea id="content" name="content" required placeholder="Write your post content"></textarea>
        </div>

        <div class="form-group">
          <label for="categories">Select Categories:</label>
          <select id="categories" name="categories[]" multiple required>
            <!-- Categories will be populated by JavaScript -->
          </select>
          <small>Hold Ctrl (Windows) or Command (Mac) to select multiple categories.</small>
        </div>

        <div class="button-container">
          <button type="button" onclick="window.location.href='/'" class="cancel-button">Cancel</button>
          <button type="submit">Submit Post</button>
        </div>
      </form>
    </div>
  </div>
  <script>

    fetch("/categories")
      .then(response => response.json())
      .then(categories => {
        const categoriesSelect = document.getElementById("categories");
        categories.forEach(category => {
          const option = document.createElement("option");
          option.value = category.ID;
          option.textContent = category.Name;
          categoriesSelect.appendChild(option);
        });
      })
      .catch(error => console.error("Error fetching categories:", error));

    document.querySelector("form").addEventListener("submit", function (event) {
      event.preventDefault();
      const title = document.getElementById("title").value;
      const content = document.getElementById("content").value;
      const categories = Array.from(document.getElementById("categories").selectedOptions)
        .map(option => option.value);

      const postData = new URLSearchParams();
      postData.append("title", title);
      postData.append("content", content);
      categories.forEach(category => postData.append("categories[]", category));

      fetch("/create-post", {
        method: "POST",
        body: postData,
      })
        .then(response => {
          if (response.redirected) {
            showNotification("Post created successfully!");
            setTimeout(() => {
              window.location.href = response.url;
            }, 2000);
          } else {
            return response.json();
          }
        })
        .then(data => {
          if (data && data.message) {
            showNotification(data.message, "error");
          }
        })
        .catch(error => {
          console.error("Error:", error);
          showNotification("Failed to create post", "error");
        });
    });

    function showNotification(message, type = "success") {
      const notification = document.createElement("div");
      notification.textContent = message;
      notification.className = `notification ${type}`;
      document.body.appendChild(notification);

      setTimeout(() => {
        notification.classList.add("show");
      }, 10);

      setTimeout(() => {
        notification.classList.remove("show");
        setTimeout(() => {
          notification.remove();
        }, 500);
      }, 2000);
    }
  </script>
</body>

</html>